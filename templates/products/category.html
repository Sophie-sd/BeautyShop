{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} - Beauty Shop{% endblock %}
{% block description %}{{ category.meta_description|default:category.description|truncatewords:20 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<section class="category-section section-padding">
    <div class="container">
        
        <div class="section-header text-center">
            <h1 class="section-title">{{ category.name }}</h1>
            {% if category.description %}
                <p class="section-subtitle">{{ category.description }}</p>
            {% endif %}
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —ñ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è -->
        <div class="filters-panel">
            <div class="filters-container">
                <div class="filters-left">
                    <!-- –§—ñ–ª—å—Ç—Ä –∑–∞ —Ü—ñ–Ω–æ—é -->
                    <div class="filter-group">
                        <label class="filter-label">–¶—ñ–Ω–∞ (‚Ç¥)</label>
                        <div class="price-range-inputs">
                            <input type="number" class="price-input" id="priceFrom" placeholder="–í—ñ–¥" min="0">
                            <span>‚Äî</span>
                            <input type="number" class="price-input" id="priceTo" placeholder="–î–æ" min="0">
                        </div>
                    </div>
                    
                    <!-- –§—ñ–ª—å—Ç—Ä –∑–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—é -->
                    <div class="filter-group">
                        <label class="filter-label">–ù–∞—è–≤–Ω—ñ—Å—Ç—å</label>
                        <select class="filter-select" id="availability">
                            <option value="">–í—Å—ñ —Ç–æ–≤–∞—Ä–∏</option>
                            <option value="in_stock">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
                            <option value="out_of_stock">–ü—ñ–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
                        </select>
                    </div>
                    
                    <!-- –§—ñ–ª—å—Ç—Ä –∑–∞ —Ç–∏–ø–æ–º -->
                    <div class="filter-group">
                        <label class="filter-label">–¢–∏–ø —Ç–æ–≤–∞—Ä—É</label>
                        <select class="filter-select" id="productType">
                            <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                            <option value="sale">–ê–∫—Ü—ñ–π–Ω—ñ</option>
                            <option value="new">–ù–æ–≤–∏–Ω–∫–∏</option>
                            <option value="top">–•—ñ—Ç–∏ –ø—Ä–æ–¥–∞–∂—É</option>
                        </select>
                    </div>
                </div>
                
                <!-- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è -->
                <div class="sort-group">
                    <label class="sort-label">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</label>
                    <select class="filter-select" id="sortBy">
                        <option value="default">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</option>
                        <option value="price_asc">–ó–∞ —Ü—ñ–Ω–æ—é: –≤—ñ–¥ –¥–µ—à–µ–≤–∏—Ö</option>
                        <option value="price_desc">–ó–∞ —Ü—ñ–Ω–æ—é: –≤—ñ–¥ –¥–æ—Ä–æ–≥–∏—Ö</option>
                        <option value="name">–ó–∞ –Ω–∞–∑–≤–æ—é</option>
                        <option value="popular">–ó–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—é</option>
                        <option value="new">–ó–∞ –Ω–æ–≤–∏–∑–Ω–æ—é</option>
                    </select>
                </div>
            </div>
        </div>
        
        {% if products %}
            <div class="products-grid" id="productsGrid">
                {% for product in products %}
                    <div class="product-card" 
                         data-price="{{ product.retail_price }}" 
                         data-sale-price="{{ product.sale_price|default:product.retail_price }}"
                         data-in-stock="{{ product.is_in_stock }}"
                         data-is-sale="{{ product.is_sale }}"
                         data-is-new="{{ product.is_new }}"
                         data-is-top="{{ product.is_top }}"
                         data-name="{{ product.name }}">
                        <a href="{{ product.get_absolute_url }}" class="product-link">
                            <div class="product-image">
                                {% if product.images.first %}
                                    <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" loading="lazy">
                                {% else %}
                                    <div class="product-placeholder">
                                        <span>üì¶</span>
                                    </div>
                                {% endif %}
                                
                                <!-- –Ü–∫–æ–Ω–∫–∞ –æ–±—Ä–∞–Ω–æ–≥–æ -->
                                <div class="wishlist-icon" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ">
                                    <span class="heart-icon">‚ô°</span>
                                </div>
                                
                                <!-- –ë–µ–π–¥–∂—ñ -->
                                {% if product.is_sale or product.is_new or product.is_top %}
                                    <div class="product-badges">
                                        {% if product.is_sale %}
                                            <span class="badge badge-sale">-{{ product.get_discount_percentage }}%</span>
                                        {% endif %}
                                        {% if product.is_new %}
                                            <span class="badge badge-new">NEW</span>
                                        {% endif %}
                                        {% if product.is_top %}
                                            <span class="badge badge-top">–•–Ü–¢</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="product-content">
                                <h3 class="product-name">{{ product.name }}</h3>
                                
                                <div class="product-price">
                                    {% if product.is_sale and product.sale_price %}
                                        <span class="price-new">{{ product.sale_price }} ‚Ç¥</span>
                                        <span class="price-old">{{ product.retail_price }} ‚Ç¥</span>
                                    {% else %}
                                        <span class="price-current">{{ product.retail_price }} ‚Ç¥</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        
                        <div class="product-actions">
                            <button class="btn-add-cart" data-product-id="{{ product.id }}">
                                –î–æ –∫–æ—à–∏–∫–∞
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1" class="pagination-link">–ü–µ—Ä—à–∞</a>
                        <a href="?page={{ page_obj.previous_page_number }}" class="pagination-link">–ü–æ–ø–µ—Ä–µ–¥–Ω—è</a>
                    {% endif %}
                    
                    <span class="pagination-current">
                        –°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page_obj.number }} –∑ {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}" class="pagination-link">–ù–∞—Å—Ç—É–ø–Ω–∞</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-link">–û—Å—Ç–∞–Ω–Ω—è</a>
                    {% endif %}
                </div>
            {% endif %}
        {% else %}
            <!-- –ü–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–∞–Ω -->
            <div class="empty-state">
                <div class="empty-state-icon">üõçÔ∏è</div>
                <h2>–í —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h2>
                <p>–°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —ñ–Ω—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∞–±–æ –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</p>
                <a href="{% url 'core:catalog' %}" class="btn-back-catalog">
                    ‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É
                </a>
            </div>
        {% endif %}
        
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    const productsGrid = document.getElementById('productsGrid');
    const productCards = Array.from(document.querySelectorAll('.product-card'));
    
    // –§—ñ–ª—å—Ç—Ä–∏
    const priceFrom = document.getElementById('priceFrom');
    const priceTo = document.getElementById('priceTo');
    const availability = document.getElementById('availability');
    const productType = document.getElementById('productType');
    const sortBy = document.getElementById('sortBy');
    
    // –§—É–Ω–∫—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
    function filterAndSortProducts() {
        let filteredCards = [...productCards];
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Ü—ñ–Ω–æ—é
        const minPrice = parseFloat(priceFrom.value) || 0;
        const maxPrice = parseFloat(priceTo.value) || Infinity;
        
        filteredCards = filteredCards.filter(card => {
            const price = parseFloat(card.dataset.salePrice);
            return price >= minPrice && price <= maxPrice;
        });
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—é
        if (availability.value) {
            filteredCards = filteredCards.filter(card => {
                const inStock = card.dataset.inStock === 'True';
                return availability.value === 'in_stock' ? inStock : !inStock;
            });
        }
        
        // –§—ñ–ª—å—Ç—Ä –∑–∞ —Ç–∏–ø–æ–º
        if (productType.value) {
            filteredCards = filteredCards.filter(card => {
                return card.dataset[`is${productType.value.charAt(0).toUpperCase()}${productType.value.slice(1)}`] === 'True';
            });
        }
        
        // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
        switch(sortBy.value) {
            case 'price_asc':
                filteredCards.sort((a, b) => parseFloat(a.dataset.salePrice) - parseFloat(b.dataset.salePrice));
                break;
            case 'price_desc':
                filteredCards.sort((a, b) => parseFloat(b.dataset.salePrice) - parseFloat(a.dataset.salePrice));
                break;
            case 'name':
                filteredCards.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));
                break;
            case 'new':
                filteredCards.sort((a, b) => (b.dataset.isNew === 'True') - (a.dataset.isNew === 'True'));
                break;
        }
        
        // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –∫–∞—Ä—Ç–∫–∏
        productCards.forEach(card => card.style.display = 'none');
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ —Ç–∞ –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ
        filteredCards.forEach(card => {
            card.style.display = 'flex';
            productsGrid.appendChild(card);
        });
    }
    
    // –ü–æ–¥—ñ—ó –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    [priceFrom, priceTo, availability, productType, sortBy].forEach(element => {
        element.addEventListener('change', filterAndSortProducts);
    });
    
    priceFrom.addEventListener('input', filterAndSortProducts);
    priceTo.addEventListener('input', filterAndSortProducts);
    
    // –Ü–∫–æ–Ω–∫–∏ –æ–±—Ä–∞–Ω–æ–≥–æ
    const wishlistIcons = document.querySelectorAll('.wishlist-icon');
    
    wishlistIcons.forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.dataset.productId;
            const isActive = this.classList.contains('active');
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è
            this.style.transform = 'scale(1.3)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 200);
            
            if (isActive) {
                // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ
                fetch('/wishlist/remove/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `product_id=${productId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.remove('active');
                        this.querySelector('.heart-icon').textContent = '‚ô°';
                    }
                });
            } else {
                // –î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ
                fetch('/wishlist/add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `product_id=${productId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.add('active');
                        this.querySelector('.heart-icon').textContent = '‚ô•';
                    }
                });
            }
        });
    });
    
    // –ö–Ω–æ–ø–∫–∏ "–î–æ –∫–æ—à–∏–∫–∞"
    const addToCartBtns = document.querySelectorAll('.btn-add-cart');
    
    addToCartBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const productId = this.dataset.productId;
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏
            this.classList.add('animating');
            
            fetch('/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `product_id=${productId}&quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.textContent = '‚úì –î–æ–¥–∞–Ω–æ';
                    this.classList.remove('animating');
                    this.classList.add('added');
                    
                    setTimeout(() => {
                        this.textContent = '–î–æ –∫–æ—à–∏–∫–∞';
                        this.classList.remove('added');
                    }, 2000);
                    
                    updateCartCount(data.cart_count);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.classList.remove('animating');
            });
        });
    });
    
    // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function updateCartCount(count) {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = count;
        }
    }
});
</script>
{% endblock %}

