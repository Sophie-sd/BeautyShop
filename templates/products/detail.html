{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Beauty Shop{% endblock %}
{% block description %}{{ product.meta_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail">
    <div class="container">
        
        <div class="product-detail-grid">
            <!-- –ì–∞–ª–µ—Ä–µ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å -->
            <div class="product-gallery">
                <div class="product-main-image" id="mainImage">
                    {% if product.images.all %}
                        <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" id="currentImage">
                    {% else %}
                        <div class="product-placeholder">
                            <span>üì¶</span>
                        </div>
                    {% endif %}
                </div>
                
                {% if product.images.count > 1 %}
                <div class="product-thumbnails">
                    {% for image in product.images.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" data-image="{{ image.image.url }}">
                        <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–æ–≤–∞—Ä -->
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                
                {% if product.sku %}
                <div class="product-sku">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</div>
                {% endif %}
                
                <!-- –ë–µ–π–¥–∂—ñ -->
                {% if product.is_sale_active or product.is_new %}
                <div class="product-badges">
                    {% if product.is_sale_active %}
                        <span class="badge badge-sale">SALE -{{ product.get_discount_percentage }}%</span>
                    {% endif %}
                    {% if product.is_new %}
                        <span class="badge badge-new">NEW</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- –¶—ñ–Ω–∞ -->
                <div class="product-detail-price">
                    {% if user.is_authenticated and user.is_wholesale and not user.is_staff and not user.is_superuser %}
                        <!-- –î–ª—è –æ–ø—Ç–æ–≤–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤: –æ–ø—Ç–æ–≤–∞ (–∞–±–æ –∞–∫—Ü—ñ–π–Ω–∞ –æ–ø—Ç–æ–≤–∞) + –ø–µ—Ä–µ–∫—Ä–µ—Å–ª–µ–Ω–∞ —Ä–æ–∑–¥—Ä—ñ–±–Ω–∞ -->
                        {% if product.wholesale_price %}
                            {% if product.is_sale_active and product.sale_wholesale_price %}
                                <span class="price-current" data-wholesale-price="{{ product.sale_wholesale_price }}">{{ product.sale_wholesale_price }} ‚Ç¥</span>
                                <span class="price-old">{{ product.wholesale_price }} ‚Ç¥</span>
                                <span class="price-wholesale-label">–ê–∫—Ü—ñ–π–Ω–∞ –æ–ø—Ç–æ–≤–∞ —Ü—ñ–Ω–∞</span>
                            {% else %}
                                <span class="price-current" data-wholesale-price="{{ product.wholesale_price }}">{{ product.wholesale_price }} ‚Ç¥</span>
                                <span class="price-old">{{ product.retail_price }} ‚Ç¥</span>
                                <span class="price-wholesale-label">–û–ø—Ç–æ–≤–∞ —Ü—ñ–Ω–∞</span>
                            {% endif %}
                        {% else %}
                            <span class="price-current">{{ product.retail_price }} ‚Ç¥</span>
                        {% endif %}
                    {% else %}
                        <!-- –î–ª—è –Ω–µ–∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤: —Ä–æ–∑–¥—Ä—ñ–±–Ω–∞ (–∞–±–æ –∞–∫—Ü—ñ–π–Ω–∞) + –¥–∏–Ω–∞–º—ñ—á–Ω–∞ —Ü—ñ–Ω–∞ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ -->
                        {% if product.is_sale_active and product.sale_price %}
                            <span class="price-current" 
                                  data-retail-price="{{ product.sale_price }}"
                                  {% if product.sale_price_3_qty %}data-price-3="{{ product.sale_price_3_qty }}"{% elif product.price_3_qty %}data-price-3="{{ product.price_3_qty }}"{% endif %}
                                  {% if product.sale_price_5_qty %}data-price-5="{{ product.sale_price_5_qty }}"{% elif product.price_5_qty %}data-price-5="{{ product.price_5_qty }}"{% endif %}>
                                {{ product.sale_price }} ‚Ç¥
                            </span>
                            <span class="price-old">{{ product.retail_price }} ‚Ç¥</span>
                        {% else %}
                            <span class="price-current" 
                                  data-retail-price="{{ product.retail_price }}"
                                  {% if product.price_3_qty %}data-price-3="{{ product.price_3_qty }}"{% endif %}
                                  {% if product.price_5_qty %}data-price-5="{{ product.price_5_qty }}"{% endif %}>
                                {{ product.retail_price }} ‚Ç¥
                            </span>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- –ì—Ä–∞–¥–∞—Ü—ñ—è —Ü—ñ–Ω (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–µ–∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤) -->
                {% if not user.is_authenticated or not user.is_wholesale or user.is_staff or user.is_superuser %}
                    {% if product.sale_price_3_qty or product.sale_price_5_qty or product.price_3_qty or product.price_5_qty %}
                    <div class="price-tiers">
                        <h3>–í–∏–≥—ñ–¥–Ω—ñ —Ü—ñ–Ω–∏ –ø—Ä–∏ –ø–æ–∫—É–ø—Ü—ñ:</h3>
                        <ul>
                            {% if product.sale_price_3_qty %}
                            <li>–í—ñ–¥ 3 —à—Ç - <span class="tier-price-sale">{{ product.sale_price_3_qty }} ‚Ç¥</span> <span class="tier-price-old">{{ product.price_3_qty }} ‚Ç¥</span></li>
                            {% elif product.price_3_qty %}
                            <li>–í—ñ–¥ 3 —à—Ç - {{ product.price_3_qty }} ‚Ç¥</li>
                            {% endif %}
                            {% if product.sale_price_5_qty %}
                            <li>–í—ñ–¥ 5 —à—Ç - <span class="tier-price-sale">{{ product.sale_price_5_qty }} ‚Ç¥</span> <span class="tier-price-old">{{ product.price_5_qty }} ‚Ç¥</span></li>
                            {% elif product.price_5_qty %}
                            <li>–í—ñ–¥ 5 —à—Ç - {{ product.price_5_qty }} ‚Ç¥</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                {% endif %}
                
                <!-- –ù–∞—è–≤–Ω—ñ—Å—Ç—å -->
                <div class="product-stock">
                    {% if product.is_in_stock %}
                        <span class="stock-available">‚úì –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ ({{ product.stock }} —à—Ç)</span>
                    {% else %}
                        <span class="stock-unavailable">‚úó –ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                    {% endif %}
                </div>
                
                <!-- –î—ñ—ó -->
                {% if product.is_in_stock %}
                <div class="product-detail-actions">
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" data-action="decrease" aria-label="–ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å">‚àí</button>
                        <input type="number" class="quantity-input" value="1" min="1" max="{{ product.stock }}" id="productQuantity" aria-label="–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—É">
                        <button type="button" class="quantity-btn" data-action="increase" aria-label="–ó–±—ñ–ª—å—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å">+</button>
                    </div>
                    <button type="button" class="btn-add-cart" data-product-id="{{ product.id }}" data-product-name="{{ product.name }}">
                        –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫
                    </button>
                    <button type="button" class="btn-wishlist" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –≤ —Å–ø–∏—Å–æ–∫ –±–∞–∂–∞–Ω—å" aria-label="–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ">
                        ‚ô°
                    </button>
                </div>
                {% endif %}
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—è -->
                <div class="product-category-link">
                    <a href="{{ product.category.get_absolute_url }}" class="btn-back-category">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        <span>{{ product.category.name }}</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∏ –∑ –æ–ø–∏—Å–æ–º —Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ -->
        <div class="product-tabs">
            <div class="product-tabs-nav">
                <button type="button" class="product-tab-btn active" data-tab="description">–û–ø–∏—Å</button>
                <button type="button" class="product-tab-btn" data-tab="characteristics">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</button>
            </div>
            
            <div class="product-tabs-content">
                <!-- –û–ø–∏—Å -->
                <div class="product-tab-panel active" data-panel="description">
                    {% if product.description %}
                        <div class="product-description">
                            {{ product.description|safe }}
                        </div>
                    {% else %}
                        <p class="empty-state-text">–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É –≤—ñ–¥—Å—É—Ç–Ω—ñ–π</p>
                    {% endif %}
                </div>
                
                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                <div class="product-tab-panel" data-panel="characteristics">
                    {% if product.characteristics %}
                        <div class="product-characteristics">
                            {{ product.characteristics|safe }}
                        </div>
                    {% else %}
                        <p class="empty-state-text">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä—É –≤—ñ–¥—Å—É—Ç–Ω—ñ</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏ -->
        {% with similar=product.get_similar_products %}
        {% if similar %}
        <section class="similar-products">
            <h2 class="section-title text-center">–°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏</h2>
            <div class="products-grid">
                {% for item in similar %}
                    {% include 'includes/product_card.html' with product=item %}
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endwith %}
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
    const tabBtns = document.querySelectorAll('.product-tab-btn');
    const tabPanels = document.querySelectorAll('.product-tab-panel');
    
    if (tabBtns.length > 0 && tabPanels.length > 0) {
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const targetTab = this.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                tabPanels.forEach(p => p.classList.remove('active'));
                
                this.classList.add('active');
                const targetPanel = document.querySelector(`[data-panel="${targetTab}"]`);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                }
            });
        });
    }
    
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    const thumbnails = document.querySelectorAll('.thumbnail');
    const currentImage = document.getElementById('currentImage');
    
    if (thumbnails.length > 0 && currentImage) {
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const imageUrl = this.dataset.image;
                
                if (imageUrl) {
                    currentImage.src = imageUrl;
                    const thumbImg = this.querySelector('img');
                    if (thumbImg) {
                        currentImage.alt = thumbImg.alt || '';
                    }
                }
                
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
    
    // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–∞ –∫–æ—à–∏–∫–æ–º
    const quantityInput = document.getElementById('productQuantity');
    const quantityBtns = document.querySelectorAll('.quantity-btn');
    const addToCartBtn = document.querySelector('.btn-add-cart');
    
    if (quantityInput && quantityBtns.length > 0) {
        quantityBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const action = this.dataset.action;
                let value = parseInt(quantityInput.value) || 1;
                const max = parseInt(quantityInput.max) || 999;
                
                if (action === 'increase' && value < max) {
                    quantityInput.value = value + 1;
                } else if (action === 'decrease' && value > 1) {
                    quantityInput.value = value - 1;
                }
                
                quantityInput.dispatchEvent(new Event('change'));
            });
        });
    }
    
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω—É
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –∫–æ—à–∏–∫–∞
    function updateCartCount(count) {
        const cartCounts = document.querySelectorAll('.cart-count, .cart-badge');
        cartCounts.forEach(badge => {
            if (badge) {
                badge.textContent = count;
                if (count > 0) {
                    badge.classList.remove('badge-hidden');
                    badge.style.display = 'flex';
                }
            }
        });
    }
    
    // –î–∏–Ω–∞–º—ñ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω–∏ –¥–ª—è –Ω–µ–∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–≥—Ä–∞–¥–∞—Ü—ñ—è —Ü—ñ–Ω)
    const priceElement = document.querySelector('.price-current');
    
    if (priceElement && quantityInput) {
        const retailPrice = priceElement.dataset.retailPrice;
        const price3 = priceElement.dataset.price3;
        const price5 = priceElement.dataset.price5;
        
        if (retailPrice && (price3 || price5)) {
            function updatePrice() {
                const quantity = parseInt(quantityInput.value) || 1;
                let currentPrice = retailPrice;
                
                if (quantity >= 5 && price5) {
                    currentPrice = price5;
                } else if (quantity >= 3 && price3) {
                    currentPrice = price3;
                }
                
                priceElement.textContent = currentPrice + ' ‚Ç¥';
            }
            
            quantityInput.addEventListener('change', updatePrice);
            quantityInput.addEventListener('input', updatePrice);
        }
    }
    
    // –°–∏—Å—Ç–µ–º–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <svg class="notification-icon" viewBox="0 0 24 24" fill="none">
                    ${type === 'success' 
                        ? '<path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
                        : '<path d="M12 8V12M12 16H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
                    }
                </svg>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}

