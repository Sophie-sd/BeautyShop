{% extends 'base.html' %}
{% load static %}

{% block title %}Оформлення замовлення - Beauty Shop{% endblock %}

{% block body_class %}cart-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
<link rel="stylesheet" href="{% static 'css/order-form.css' %}">
<style>
    .autocomplete-container {
        position: relative;
    }
    .autocomplete-results,
    .warehouse-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color, #ddd);
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .autocomplete-item,
    .warehouse-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color, #f0f0f0);
        transition: background 0.2s;
    }
    .autocomplete-item:hover,
    .warehouse-item:hover {
        background: var(--bg-hover, #f5f5f5);
    }
    .warehouse-item {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .warehouse-item.selected {
        background: var(--primary-light, #e3f2fd);
        border-left: 3px solid var(--primary-color, #2196F3);
    }
    .warehouse-number {
        font-weight: 600;
        color: var(--primary-color, #2196F3);
        min-width: 50px;
    }
    .warehouse-address {
        flex: 1;
        font-size: 14px;
    }
    .loading,
    .no-results,
    .error {
        padding: 12px;
        text-align: center;
        color: var(--text-muted, #666);
    }
    .delivery-type-wrapper,
    .delivery-address-wrapper {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<section class="order-section section-padding">
    <div class="container">
        <h1 class="section-title">Оформлення замовлення</h1>
        
        <div class="order-content">
            <div class="order-form-wrapper">
                <form method="post" class="order-form">
                    {% csrf_token %}
                    
                    <div class="form-section">
                        <h3>Контактні дані</h3>
                        <div class="form-group">
                            <label for="first_name">Ім'я *</label>
                            <input type="text" id="first_name" name="first_name" class="form-control" 
                                   value="{{ user.first_name|default:'' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="last_name">Прізвище *</label>
                            <input type="text" id="last_name" name="last_name" class="form-control" 
                                   value="{{ user.last_name|default:'' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="middle_name">По-батькові</label>
                            <input type="text" id="middle_name" name="middle_name" class="form-control" 
                                   value="{{ user.middle_name|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Телефон *</label>
                            <input type="tel" id="phone" name="phone" class="form-control" 
                                   value="{{ user.phone|default:'' }}" required 
                                   placeholder="+380">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" class="form-control" 
                                   value="{{ user.email|default:'' }}" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Доставка</h3>
                        <div class="form-group">
                            <label for="delivery_method">Спосіб доставки *</label>
                            <select id="delivery_method" name="delivery_method" class="form-control" required>
                                <option value="">Оберіть спосіб доставки</option>
                                <option value="nova_poshta">Нова Пошта</option>
                                <option value="ukrposhta">Укрпошта</option>
                                <option value="courier">Кур'єр</option>
                                <option value="pickup">Самовивіз</option>
                            </select>
                        </div>
                        
                        <div class="form-group autocomplete-container">
                            <label for="delivery_city">Місто *</label>
                            <input type="text" id="delivery_city" name="delivery_city" class="form-control" autocomplete="off">
                            <div id="city_results" class="autocomplete-results"></div>
                            <input type="hidden" id="np_city_ref" name="np_city_ref">
                        </div>
                        
                        <div class="form-group delivery-type-wrapper">
                            <label for="delivery_type">Тип доставки *</label>
                            <select id="delivery_type" name="delivery_type" class="form-control">
                                <option value="">Оберіть тип доставки</option>
                                <option value="warehouse">Відділення</option>
                                <option value="postomat">Поштомат</option>
                            </select>
                        </div>
                        
                        <div class="form-group delivery-address-wrapper">
                            <label for="delivery_address">Адреса/Відділення *</label>
                            <input type="text" id="delivery_address" name="delivery_address" class="form-control">
                            <div id="warehouse_results" class="warehouse-results"></div>
                            <input type="hidden" id="np_warehouse_ref" name="np_warehouse_ref">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Оплата</h3>
                        <div class="payment-methods">
                            <label class="payment-method">
                                <input type="radio" name="payment_method" value="cash" checked>
                                <span>Оплата при отриманні</span>
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="payment_method" value="liqpay">
                                <span>Онлайн оплата (LiqPay)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Коментар до замовлення</h3>
                        <div class="form-group">
                            <textarea id="notes" name="notes" class="form-control" rows="4" 
                                      placeholder="Додайте коментар (необов'язково)"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <a href="{% url 'cart:detail' %}" class="btn btn-outline">Повернутись до кошика</a>
                        <button type="submit" class="btn btn-primary">Підтвердити замовлення</button>
                    </div>
                </form>
            </div>
            
            <div class="order-summary">
                <h3>Ваше замовлення</h3>
                
                <div class="order-items">
                    {% for item in cart %}
                    <div class="order-item">
                        <div class="item-info">
                            <span class="item-name">{{ item.product.name }}</span>
                            <span class="item-quantity">× {{ item.quantity }}</span>
                        </div>
                        <span class="item-price">{{ item.total_price }} ₴</span>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="order-totals">
                    <div class="total-row">
                        <span>Товари:</span>
                        <span>{{ cart.get_total_price }} ₴</span>
                    </div>
                    
                    {% if request.session.promo_discount %}
                    <div class="total-row promo-row">
                        <span>Промокод ({{ request.session.promo_code }}):</span>
                        <span>{{ request.session.promo_discount }} ₴</span>
                    </div>
                    {% endif %}
                    
                    <div class="total-row total-final">
                        <span>До сплати:</span>
                        <span class="total-amount">
                            {% if request.session.promo_discount %}
                                {{ cart.get_total_price|add:request.session.promo_discount|floatformat:2 }} ₴
                            {% else %}
                                {{ cart.get_total_price }} ₴
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="order-info">
                    <p>Ми зв'яжемося з вами для підтвердження замовлення</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/order-form.js' %}"></script>
{% endblock %}
