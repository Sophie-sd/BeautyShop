# 🔐 Короткий довідник: Вхід в адмінку та особистий кабінет

## ✅ Що було виправлено:

### Проблема:
При спробі ввести "admin" + пароль в особистий кабінет (`/users/login/`) — користувача перекидало в адмінку.

### Рішення:
Форма входу в особистий кабінет тепер використовує **ТІЛЬКИ** `WholesaleClientBackend`, який **відразу блокує** спроби входу адміністраторів.

---

## 🎯 Як це працює зараз:

### Сценарій 1: Спроба ввійти в особистий кабінет як адміністратор

**Користувач:** Вводить `admin` + пароль на сторінці `/users/login/`

**Результат:** ❌ Помилка
```
🔒 Доступ заборонено. 
Адміністратори можуть входити тільки через /admin/
```

**Що відбувається:**
1. `CustomLoginView` викликає ТІЛЬКИ `WholesaleClientBackend`
2. Backend шукає email="admin" → не знаходить
3. Backend шукає phone="admin" → не знаходить
4. Backend повертає `None`
5. View перевіряє чи це адміністратор → так, is_staff=True
6. Показує помилку
7. Django **НЕ пробує** інші backends
8. Користувач **НЕ заходить** в систему

---

### Сценарій 2: Спроба ввійти в особистий кабінет як незареєстрований користувач

**Користувач:** Вводить будь-який email/телефон який не зареєстрований

**Результат:** ❌ Помилка
```
Користувача з таким email або телефоном не зареєстровано. 
Будь ласка, зареєструйтеся.
```

**Що відбувається:**
1. `WholesaleClientBackend` шукає користувача
2. Не знаходить
3. Повертає `None`
4. View показує помилку про реєстрацію

---

### Сценарій 3: Правильний вхід оптового клієнта

**Користувач:** Реєструється через форму, підтверджує email, вводить свій email/телефон + пароль

**Результат:** ✅ Успішний вхід в особистий кабінет

**Що відбувається:**
1. `WholesaleClientBackend` знаходить користувача за email або phone
2. Перевіряє що це НЕ адміністратор (is_staff=False)
3. Перевіряє пароль
4. Перевіряє що is_active=True
5. Повертає користувача
6. `CustomLoginView` логінить користувача
7. Редірект на `/users/profile/`

---

### Сценарій 4: Вхід адміністратора в адмінку

**Користувач:** Відкриває `/admin/`, вводить `beautyshop` + пароль

**Результат:** ✅ Успішний вхід в адмін-панель

**Що відбувається:**
1. Стандартна форма Django Admin
2. Використовує `AdminOnlyBackend`
3. Backend знаходить користувача за username
4. Перевіряє що is_staff=True або is_superuser=True
5. Перевіряє пароль
6. Повертає користувача
7. Вхід в адмінку

---

## 📊 Поточний стан БД:

```
✅ Адміністраторів: 1
   - beautyshop | admin@beautyshop.ua | is_staff=True | is_superuser=True

✅ Оптових клієнтів: 0 (очищено!)
```

---

## 🔑 Як увійти:

### Для адміністраторів:

1. Відкрити: `https://beautyshop-django.onrender.com/admin/`
2. Ввести username: `beautyshop`
3. Ввести пароль адміністратора
4. Натиснути "Увійти"

**Важливо:** 
- НЕ використовуйте `/users/login/` для входу адміністратора!
- Тільки пряме посилання `/admin/`

---

### Для оптових клієнтів:

1. **Спочатку зареєструватися:** `https://beautyshop-django.onrender.com/users/register/`
2. Заповнити форму (ім'я, email, телефон, пароль)
3. Підтвердити email (перейти за посиланням з листа)
4. Відкрити: `https://beautyshop-django.onrender.com/users/login/`
5. Ввести **email** або **телефон** (НЕ username!)
6. Ввести пароль
7. Натиснути "Увійти"

**Важливо:**
- Вхід ТІЛЬКИ через email або телефон
- Username НЕ працює в особистому кабінеті
- Адміністратори НЕ можуть заходити

---

## 🛡️ Захист:

### Що НЕ можна зробити:

❌ Ввійти в особистий кабінет через username  
❌ Ввійти в особистий кабінет як адміністратор  
❌ Зареєструватися з правами адміністратора  
❌ Обійти email верифікацію  
❌ Змінити is_staff через форми  

### Що можна зробити:

✅ Зареєструватися як оптовий клієнт  
✅ Підтвердити email  
✅ Увійти через email або телефон  
✅ Замовляти від 5000 грн з оптовими цінами  
✅ Адміністратор може увійти в `/admin/`  

---

## 📝 Коротка схема:

```
┌─────────────────────────────────────────────────┐
│  ОСОБИСТИЙ КАБІНЕТ (/users/login/)              │
├─────────────────────────────────────────────────┤
│  ✅ Email або телефон + пароль                  │
│  ✅ Тільки зареєстровані оптові клієнти         │
│  ❌ Username не працює                          │
│  ❌ Адміністратори заборонені                   │
│  → Backend: WholesaleClientBackend (ТІЛЬКИ!)   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│  АДМІНКА (/admin/)                              │
├─────────────────────────────────────────────────┤
│  ✅ Username, email або телефон + пароль        │
│  ✅ Тільки is_staff=True або is_superuser=True  │
│  ❌ Звичайні клієнти заборонені                 │
│  → Backend: AdminOnlyBackend                    │
└─────────────────────────────────────────────────┘
```

---

## ⚡ Швидкий тест:

### Тест 1: Спробувати ввійти як "admin" в особистий кабінет
```
URL: /users/login/
Ввести: admin + пароль
Очікується: Помилка "🔒 Доступ заборонено"
```

### Тест 2: Спробувати увійти як незареєстрований користувач
```
URL: /users/login/
Ввести: test@test.com + будь-який пароль
Очікується: Помилка "Користувача з таким email не зареєстровано"
```

### Тест 3: Вхід в адмінку
```
URL: /admin/
Ввести: beautyshop + пароль адміністратора
Очікується: Успішний вхід в адмін-панель
```

### Тест 4: Реєстрація нового клієнта
```
URL: /users/register/
Заповнити форму → Підтвердити email → Ввійти через /users/login/
Очікується: Успішний вхід в особистий кабінет
```

---

## 🚨 Якщо щось не працює:

1. **Очистити кеш браузера:** Ctrl+Shift+Delete
2. **Перевірити URL:** Адмінка — `/admin/`, клієнти — `/users/login/`
3. **Перевірити чи підтверджено email:** Для клієнтів обов'язково!
4. **Перевірити чи правильні дані:** Email/телефон для клієнтів, username для адмінів
5. **Перевірити логи:** `python manage.py shell` → перевірити користувачів

---

## 📚 Детальна документація:

- `SECURITY_GUIDE.md` — повний опис безпеки (650+ рядків)
- `BANNERS_GUIDE.md` — робота з банерами
- `ADMIN_GUIDE.md` — робота з адмін-панеллю

---

**Останнє оновлення:** Жовтень 2024  
**Статус:** ✅ Працює коректно  
**База даних:** ✅ Очищено від тестових користувачів

