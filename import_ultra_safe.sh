#!/usr/bin/env bash
# Ð£Ð›Ð¬Ð¢Ð Ð-Ð‘Ð•Ð—ÐŸÐ•Ð§ÐÐ˜Ð™ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Render
# Ð†Ð¼Ð¿Ð¾Ñ€Ñ‚ÑƒÑ” Ð´ÑƒÐ¶Ðµ Ð¿Ð¾Ð²Ñ–Ð»ÑŒÐ½Ð¾, Ð°Ð»Ðµ ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ð¾

echo "ðŸŒ Ð£Ð›Ð¬Ð¢Ð Ð-Ð‘Ð•Ð—ÐŸÐ•Ð§ÐÐ˜Ð™ Ð†ÐœÐŸÐžÐ Ð¢ (Ð´ÑƒÐ¶Ðµ Ð¿Ð¾Ð²Ñ–Ð»ÑŒÐ½Ð¾, Ð°Ð»Ðµ ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ð¾)"
echo "=========================================================="
echo ""

# Ð’Ð¸Ð¼Ð¸ÐºÐ°Ñ”Ð¼Ð¾ Ð²ÑÑ– Ñ„Ð¾Ð½Ð¾Ð²Ñ– Ð¿Ñ€Ð¾Ñ†ÐµÑÐ¸
pkill -f "manage.py" 2>/dev/null

echo "ðŸ“Š ÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ ÑÑ‚Ð°Ð½:"
python manage.py check_import_status
echo ""

echo "âš™ï¸ Ð ÐµÐ¶Ð¸Ð¼:"
echo "  â€¢ 1 worker"
echo "  â€¢ ÐŸÐ¾ 50 Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð·Ð° Ñ€Ð°Ð·"
echo "  â€¢ Ð— Ð¿Ð°ÑƒÐ·Ð°Ð¼Ð¸ Ð¼Ñ–Ð¶ Ð±Ð°Ñ‚Ñ‡Ð°Ð¼Ð¸"
echo "  â€¢ Ð‘ÐµÐ· Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½ÑŒ"
echo "  â€¢ Ð— retry Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ¸"
echo ""

# Ð†Ð¼Ð¿Ð¾Ñ€Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¿Ð¾ 50 Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² 10 Ñ€Ð°Ð·Ñ–Ð²
for i in {1..10}; do
    echo "ðŸ”„ Ð†Ñ‚ÐµÑ€Ð°Ñ†Ñ–Ñ $i/10..."
    python manage.py import_products_sitemap --workers 1 --skip-images --limit 50
    echo "  ÐŸÐ°ÑƒÐ·Ð° 5 ÑÐµÐºÑƒÐ½Ð´..."
    sleep 5
    
    # Ð Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð» ÐºÐ¾Ð¶Ð½Ñ– 3 Ñ–Ñ‚ÐµÑ€Ð°Ñ†Ñ–Ñ—
    if [ $((i % 3)) -eq 0 ]; then
        echo "  ðŸ“‚ Ð Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð» Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ñ–ÑÑ…..."
        python manage.py assign_categories
    fi
    
    gc.collect 2>/dev/null || true
done

echo ""
echo "âœ… Ð†Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
python manage.py check_import_status

