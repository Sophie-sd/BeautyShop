// Custom Admin JavaScript для Beauty Shop
// Покращує UX, автоматизує рутинні операції

(function() {
    'use strict';
    
    // ============================================
    // UTILITY ФУНКЦІЇ
    // ============================================
    
    const BeautyShopAdmin = {
        // Показати повідомлення
        showMessage(text, type = 'success') {
            const message = document.createElement('div');
            message.className = `admin-flash-message admin-flash-${type}`;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : '#f56565'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(message), 300);
            }, 3000);
        },
        
        // Копіювати в буфер
        copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('Скопійовано в буфер обміну!');
                });
            } else {
                // Fallback для старих браузерів
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                this.showMessage('Скопійовано в буфер обміну!');
            }
        },
        
        // Підтвердження дії
        confirm(message, callback) {
            if (window.confirm(message)) {
                callback();
            }
        }
    };
    
    // Експортуємо в глобальну область
    window.BeautyShopAdmin = BeautyShopAdmin;
    
    // ============================================
    // DOCUMENT READY
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        
        // ========== ФОРМИ ==========
        
        // Покращуємо UX при відправці форм
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('input[type="submit"]');
                if (submitBtn && !submitBtn.dataset.submitting) {
                    submitBtn.dataset.submitting = 'true';
                    submitBtn.disabled = true;
                    const originalValue = submitBtn.value;
                    submitBtn.value = 'Збереження...';
                    
                    // Якщо форма не відправиться за 10 секунд, повертаємо кнопку
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.value = originalValue;
                        delete submitBtn.dataset.submitting;
                    }, 10000);
                }
            });
        });
        
        // ========== SLUG АВТОЗАПОВНЕННЯ ==========
        
        const titleField = document.querySelector('#id_title, #id_name');
        const slugField = document.querySelector('#id_slug');
        
        if (titleField && slugField) {
            titleField.addEventListener('input', function() {
                // Генеруємо slug тільки якщо поле порожнє
                if (!slugField.value || slugField.dataset.autoGenerated) {
                    let slug = this.value
                        .toLowerCase()
                        .replace(/[^a-z0-9а-яєії\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                    
                    // Транслітерація українських символів
                    const ukrainianToLatin = {
                        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'h', 'ґ': 'g',
                        'д': 'd', 'е': 'e', 'є': 'ye', 'ж': 'zh', 'з': 'z',
                        'и': 'y', 'і': 'i', 'ї': 'yi', 'й': 'y', 'к': 'k',
                        'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o', 'п': 'p',
                        'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f',
                        'х': 'kh', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'shch',
                        'ю': 'yu', 'я': 'ya', 'ь': '', 'ъ': ''
                    };
                    
                    for (let [uk, lat] of Object.entries(ukrainianToLatin)) {
                        slug = slug.replace(new RegExp(uk, 'g'), lat);
                    }
                    
                    slugField.value = slug.substring(0, 50);
                    slugField.dataset.autoGenerated = 'true';
                }
            });
            
            // Якщо користувач вручну редагує slug, вимикаємо автогенерацію
            slugField.addEventListener('input', function() {
                if (this.value !== '') {
                    delete this.dataset.autoGenerated;
                }
            });
        }
        
        // ========== ПРЕВЬЮ ЗОБРАЖЕНЬ ==========
        
        const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
        imageInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Створюємо або оновлюємо превью
                        let preview = input.parentElement.querySelector('.image-preview');
                        if (!preview) {
                            preview = document.createElement('div');
                            preview.className = 'image-preview';
                            preview.style.cssText = `
                                margin-top: 15px;
                                border: 2px dashed #e2e8f0;
                                border-radius: 8px;
                                padding: 15px;
                                text-align: center;
                                background: #f7fafc;
                            `;
                            input.parentElement.appendChild(preview);
                        }
                        
                        preview.innerHTML = `
                            <img src="${e.target.result}" 
                                 style="max-width: 300px; max-height: 300px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <p style="margin: 10px 0 0 0; font-size: 13px; color: #718096;">
                                ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                            </p>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
        
        // ========== ПІДТВЕРДЖЕННЯ ВИДАЛЕННЯ ==========
        
        const deleteLinks = document.querySelectorAll('a[href*="delete"]');
        deleteLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (!confirm('Ви впевнені, що хочете видалити цей елемент? Цю дію неможливо скасувати.')) {
                    e.preventDefault();
                }
            });
        });
        
        // ========== ПОКРАЩЕННЯ ТАБЛИЦЬ ==========
        
        const resultTable = document.querySelector('#result_list');
        if (resultTable) {
            // Додаємо hover ефект для рядків
            const rows = resultTable.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                // Додаємо data-атрибут для відстеження індексу
                row.dataset.index = index;
                
                // Клік по рядку (крім чекбоксів та посилань) відкриває редагування
                row.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'A' && !e.target.closest('a')) {
                        const editLink = this.querySelector('th a, td a');
                        if (editLink) {
                            window.location.href = editLink.href;
                        }
                    }
                });
                
                // Hover ефект
                row.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                });
            });
            
            // Покращуємо сортування - додаємо візуальний feedback
            const headers = resultTable.querySelectorAll('thead th a');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const loader = document.createElement('div');
                    loader.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 8px;
                        z-index: 99999;
                        font-size: 14px;
                    `;
                    loader.textContent = '⏳ Сортування...';
                    document.body.appendChild(loader);
                });
            });
        }
        
        // ========== ФІЛЬТРИ - ПОКРАЩЕННЯ UX ==========
        
        const filterSidebar = document.querySelector('#changelist-filter');
        if (filterSidebar) {
            const filterLinks = filterSidebar.querySelectorAll('a');
            filterLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // Додаємо лоадер
                    const loader = document.createElement('div');
                    loader.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 8px;
                        z-index: 99999;
                        font-size: 14px;
                    `;
                    loader.textContent = '🔍 Фільтрація...';
                    document.body.appendChild(loader);
                });
            });
        }
        
        // ========== МАСОВІ ДІЇ - ПОКРАЩЕННЯ ==========
        
        const actionSelect = document.querySelector('select[name="action"]');
        if (actionSelect) {
            actionSelect.addEventListener('change', function() {
                const selectedAction = this.options[this.selectedIndex].text;
                if (selectedAction && selectedAction !== '---------') {
                    const checkedCount = document.querySelectorAll('input[name="_selected_action"]:checked').length;
                    if (checkedCount === 0) {
                        BeautyShopAdmin.showMessage('Оберіть хоча б один елемент', 'error');
                        this.value = '';
                    }
                }
            });
        }
        
        // ========== CKEDITOR ПОКРАЩЕННЯ ==========
        
        if (typeof CKEDITOR !== 'undefined') {
            CKEDITOR.on('instanceReady', function(event) {
                const editor = event.editor;
                
                // Додаємо кастомні стилі
                if (document.querySelector('[href*="ckeditor-custom.css"]')) {
                    editor.addContentsCss('/static/css/ckeditor-custom.css');
                }
                
                // Автозбереження в localStorage (draft)
                let autoSaveTimer;
                const formId = editor.element.$.form?.id || 'editor';
                const draftKey = `admin_draft_${formId}_${editor.name}`;
                
                // Відновлюємо draft при завантаженні
                const savedDraft = localStorage.getItem(draftKey);
                if (savedDraft && !editor.getData()) {
                    if (confirm('Знайдено збережений чернетка. Відновити?')) {
                        editor.setData(savedDraft);
                    } else {
                        localStorage.removeItem(draftKey);
                    }
                }
                
                // Автозбереження кожні 30 секунд
                editor.on('change', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(function() {
                        localStorage.setItem(draftKey, editor.getData());
                        console.log('Draft auto-saved');
                    }, 30000);
                });
                
                // Очищуємо draft після успішного збереження
                const form = editor.element.$.form;
                if (form) {
                    form.addEventListener('submit', function() {
                        localStorage.removeItem(draftKey);
                    });
                }
            });
        }
        
        // ========== ПАГІНАЦІЯ - ПОКРАЩЕННЯ ==========
        
        const paginationLinks = document.querySelectorAll('.paginator a');
        paginationLinks.forEach(link => {
            link.addEventListener('click', function() {
                // Scroll to top при зміні сторінки
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
        
        // ========== ШВИДКІ КЛАВІШІ ==========
        
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S = зберегти форму
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const submitBtn = document.querySelector('input[type="submit"][name="_save"]');
                if (submitBtn) {
                    submitBtn.click();
                    BeautyShopAdmin.showMessage('Збереження...');
                }
            }
            
            // Ctrl/Cmd + Shift + S = зберегти і продовжити редагування
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 's') {
                e.preventDefault();
                const submitBtn = document.querySelector('input[type="submit"][name="_continue"]');
                if (submitBtn) {
                    submitBtn.click();
                    BeautyShopAdmin.showMessage('Збереження та продовження...');
                }
            }
        });
        
        // ========== ЦІНИ - ВАЛІДАЦІЯ ==========
        
        const priceFields = document.querySelectorAll('input[type="number"][id*="price"]');
        priceFields.forEach(field => {
            field.addEventListener('blur', function() {
                if (this.value && parseFloat(this.value) < 0) {
                    this.style.borderColor = '#f56565';
                    BeautyShopAdmin.showMessage('Ціна не може бути від\'ємною', 'error');
                    this.value = '';
                } else {
                    this.style.borderColor = '';
                }
            });
        });
        
        // ========== АКЦІЙНІ ЦІНИ - АВТОПЕРЕВІРКА ==========
        
        const retailPriceField = document.querySelector('#id_retail_price');
        const salePriceField = document.querySelector('#id_sale_price');
        
        if (retailPriceField && salePriceField) {
            salePriceField.addEventListener('blur', function() {
                const retail = parseFloat(retailPriceField.value);
                const sale = parseFloat(this.value);
                
                if (retail && sale && sale >= retail) {
                    this.style.borderColor = '#f56565';
                    BeautyShopAdmin.showMessage('Акційна ціна повинна бути меншою за роздрібну', 'error');
                } else if (retail && sale) {
                    this.style.borderColor = '#48bb78';
                    const discount = Math.round(((retail - sale) / retail) * 100);
                    BeautyShopAdmin.showMessage(`Знижка: ${discount}%`, 'success');
                }
            });
        }
        
        // ========== ТАЙМЕРИ ДЛЯ АКЦІЙ ==========
        
        // Знаходимо всі елементи з інформацією про закінчення акції
        const updateTimers = () => {
            const timerElements = document.querySelectorAll('[data-sale-end]');
            timerElements.forEach(el => {
                const endDate = new Date(el.dataset.saleEnd);
                const now = new Date();
                const diff = endDate - now;
                
                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    if (days <= 3) {
                        el.style.color = '#f56565';
                        el.style.fontWeight = '700';
                    }
                }
            });
        };
        
        updateTimers();
        setInterval(updateTimers, 60000); // Оновлюємо кожну хвилину
        
        // ========== КОМПАКТНИЙ РЕЖИМ (EXPERIMENTAL) ==========
        
        // Додаємо перемикач компактного режиму
        const createCompactToggle = () => {
            const header = document.querySelector('#header');
            if (header && !document.querySelector('#compact-toggle')) {
                const toggle = document.createElement('button');
                toggle.id = 'compact-toggle';
                toggle.textContent = 'Компактний вигляд';
                toggle.style.cssText = `
                    position: absolute;
                    right: 100px;
                    top: 15px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.3);
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                `;
                
                toggle.addEventListener('click', function() {
                    document.body.classList.toggle('compact-mode');
                    const isCompact = document.body.classList.contains('compact-mode');
                    this.textContent = isCompact ? 'Звичайний вигляд' : 'Компактний вигляд';
                    localStorage.setItem('admin_compact_mode', isCompact);
                });
                
                // Відновлюємо з localStorage
                if (localStorage.getItem('admin_compact_mode') === 'true') {
                    document.body.classList.add('compact-mode');
                    toggle.textContent = 'Звичайний вигляд';
                }
                
                header.appendChild(toggle);
            }
        };
        
        createCompactToggle();
        
        console.log('✅ Beauty Shop Admin JS initialized');
    });
    
    // ============================================
    // ANIMATIONS
    // ============================================
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .compact-mode #result_list th,
        .compact-mode #result_list td {
            padding: 4px 6px !important;
            font-size: 12px !important;
        }
        
        .compact-mode .admin-thumbnail-small {
            width: 35px !important;
            height: 35px !important;
        }
    `;
    document.head.appendChild(style);
    
})();
